"""Vulnerability Detection Rules for Security Analysis"""
import re
from typing import Dict, List, Any


class VulnerabilityChecker:
    """Check code for known vulnerabilities"""

    # OWASP Top 10 & CWE patterns
    RULES = {
        "sql_injection": {
            "cwe": "CWE-89",
            "severity": "critical",
            "patterns": [
                r"(?:SELECT|UPDATE|DELETE|INSERT).*\+\s*(?:str|var|this\.|f['\"])",
                r"execute\s*\(\s*['\"].*['\"].*\+",
                r"query\s*=.*['\"].*['\"].*\+",
                r"\.format\s*\(.*user.*\)",
            ]
        },
        "command_injection": {
            "cwe": "CWE-78",
            "severity": "critical",
            "patterns": [
                r"os\.system\s*\(\s*(?:user|input|request)",
                r"subprocess\.(?:call|run)\s*\(\s*(?:user|input|request)",
                r"exec\s*\(\s*(?:user|input|request)",
                r"eval\s*\(\s*(?:user|input|request)",
            ]
        },
        "xss_vulnerability": {
            "cwe": "CWE-79",
            "severity": "high",
            "patterns": [
                r"innerHTML\s*=",
                r"document\.write\s*\(",
                r"\.html\s*\(\s*[^<]",
                r"outerHTML\s*=",
            ]
        },
        "hardcoded_secrets": {
            "cwe": "CWE-798",
            "severity": "critical",
            "patterns": [
                r"(?:password|passwd|pwd|api_key|apikey|secret|token)\s*=\s*['\"]([^'\"]+)['\"]",
                r"(?:password|passwd|pwd|api_key|apikey|secret|token):\s*['\"]([^'\"]+)['\"]",
            ]
        },
        "insecure_deserialization": {
            "cwe": "CWE-502",
            "severity": "high",
            "patterns": [
                r"pickle\.(?:load|loads)\s*\(",
                r"yaml\.load\s*\(",
                r"json\.loads\s*\(.*(?:eval|exec)",
                r"marshal\.loads\s*\(",
            ]
        },
        "path_traversal": {
            "cwe": "CWE-22",
            "severity": "high",
            "patterns": [
                r"open\s*\(\s*['\"]\.\.[\\/]",
                r"os\.path\.join\s*\(\s*[^,]*,\s*(?:user|input|request)",
                r"file\s*=\s*['\"]\.\.[\\/]",
            ]
        },
        "cross_site_request_forgery": {
            "cwe": "CWE-352",
            "severity": "high",
            "patterns": [
                r"@(?:app|router)\.(?:post|put|delete)\s*\(",
                r"method\s*=\s*['\"](?:POST|PUT|DELETE)['\"]",
            ]
        },
        "broken_authentication": {
            "cwe": "CWE-287",
            "severity": "critical",
            "patterns": [
                r"password.*==\s*['\"][^'\"]+['\"]",
                r"auth.*=.*(?:True|1)",
                r"bypass.*auth",
            ]
        },
        "insecure_encryption": {
            "cwe": "CWE-327",
            "severity": "high",
            "patterns": [
                r"DES\s*\(",
                r"MD5\s*\(",
                r"SHA1\s*\(",
                r"hashlib\.md5\s*\(",
                r"hashlib\.sha1\s*\(",
            ]
        },
        "xxe_injection": {
            "cwe": "CWE-611",
            "severity": "high",
            "patterns": [
                r"xml\.etree\.ElementTree\.parse",
                r"xml\.sax\.parse",
                r"minidom\.parse",
            ]
        },
    }

    @staticmethod
    def check_vulnerabilities(code: str) -> List[Dict[str, Any]]:
        """Check code for vulnerabilities"""
        vulnerabilities = []

        for vuln_type, rule_data in VulnerabilityChecker.RULES.items():
            for pattern in rule_data["patterns"]:
                matches = re.finditer(pattern, code, re.IGNORECASE | re.MULTILINE)
                for match in matches:
                    line_num = code[:match.start()].count('\n') + 1
                    vulnerabilities.append({
                        "type": vuln_type.replace('_', ' ').title(),
                        "severity": rule_data["severity"],
                        "cwe": rule_data["cwe"],
                        "line": line_num,
                        "message": f"{vuln_type.replace('_', ' ').title()} detected",
                        "match": match.group(),
                    })

        return vulnerabilities

    @staticmethod
    def get_recommendation(vuln_type: str) -> str:
        """Get security recommendation for vulnerability"""
        recommendations = {
            "sql_injection": "Use parameterized queries or prepared statements instead of string concatenation",
            "command_injection": "Avoid using shell commands with user input. Use safe APIs like subprocess.run with list arguments",
            "xss_vulnerability": "Use innerHTML carefully and sanitize all user-provided content",
            "hardcoded_secrets": "Move secrets to environment variables or secure configuration management",
            "insecure_deserialization": "Validate and sanitize serialized data. Use safe alternatives like JSON",
            "path_traversal": "Validate file paths and use os.path.abspath to prevent directory traversal",
            "cross_site_request_forgery": "Implement CSRF tokens and use SameSite cookies",
            "broken_authentication": "Implement proper authentication and use bcrypt or similar for password hashing",
            "insecure_encryption": "Use modern encryption algorithms (AES-256) and secure hashing (SHA-256+)",
            "xxe_injection": "Disable XML external entities and validate XML input",
        }
        return recommendations.get(vuln_type, "Review this security issue and implement proper mitigation")


def check_code_security(code: str) -> Dict[str, Any]:
    """Check code for security vulnerabilities"""
    vulnerabilities = VulnerabilityChecker.check_vulnerabilities(code)

    # Add recommendations
    for vuln in vulnerabilities:
        vuln["recommendation"] = VulnerabilityChecker.get_recommendation(
            vuln["type"].lower().replace(' ', '_')
        )

    return {
        "vulnerabilities": vulnerabilities,
        "total": len(vulnerabilities),
        "critical": len([v for v in vulnerabilities if v["severity"] == "critical"]),
        "high": len([v for v in vulnerabilities if v["severity"] == "high"]),
        "medium": len([v for v in vulnerabilities if v["severity"] == "medium"]),
    }
